name: Kali XFCE via ZeroTier (macOS look, fixed)

on:
  workflow_dispatch:
    inputs:
      zt_network:   { description: "ZeroTier Network ID", required: true }
      zt_api_token: { description: "ZeroTier API Token (optional)", required: false }
      vnc_password: { description: "VNC password (blank = passwordless)", required: false, default: "" }
      width:        { description: "Screen width",  required: false, default: "1366" }
      height:       { description: "Screen height", required: false, default: "768" }
      minutes:      { description: "Session duration (max 355)", required: false, default: "180" }

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install XFCE, VNC, tools (fixed)
        run: |
          set -e
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            xfce4 xfce4-goodies x11vnc xvfb dbus-x11 xterm curl jq git unzip ca-certificates \
            plank fonts-inter gsettings-desktop-schemas nmap hydra john hashcat tcpdump tshark \
            net-tools neofetch htop
          echo "XFCE and utilities installed."

      - name: Apply macOS theme (WhiteSur)
        run: |
          set -e
          mkdir -p ~/.themes ~/.icons ~/Pictures ~/.config/autostart
          git clone --depth=1 https://github.com/vinceliuice/WhiteSur-gtk-theme ~/WhiteSur-gtk-theme
          git clone --depth=1 https://github.com/vinceliuice/WhiteSur-icon-theme ~/WhiteSur-icon-theme
          git clone --depth=1 https://github.com/vinceliuice/McMojave-cursors ~/McMojave-cursors
          bash ~/WhiteSur-gtk-theme/install.sh -t ~/.themes -c dark
          bash ~/WhiteSur-icon-theme/install.sh -d ~/.icons
          bash ~/McMojave-cursors/install.sh -d ~/.icons
          curl -fsSL -o ~/Pictures/wall.jpg https://raw.githubusercontent.com/adi1090x/wallpapers/master/apple/007.jpg || true
          cat > ~/.config/autostart/plank.desktop <<'EOF'
          [Desktop Entry]
          Type=Application
          Exec=plank
          Hidden=false
          NoDisplay=false
          X-GNOME-Autostart-enabled=true
          Name=Plank
          Comment=Simple dock
          EOF

      - name: Start virtual display + XFCE
        run: |
          set -e
          export DISPLAY=:0
          Xvfb :0 -screen 0 "${{ github.event.inputs.width }}x${{ github.event.inputs.height }}x24" -nolisten tcp &
          sleep 3
          dbus-launch startxfce4 >/tmp/xfce.log 2>&1 &
          sleep 8
          xfconf-query -c xsettings -p /Net/ThemeName -s "WhiteSur-Dark" || true
          xfconf-query -c xsettings -p /Net/IconThemeName -s "WhiteSur" || true
          xfconf-query -c xsettings -p /Gtk/CursorThemeName -s "McMojave-cursors" || true
          xfconf-query -c xfce4-desktop -p /backdrop/screen0/monitor0/image-path -s "$HOME/Pictures/wall.jpg" || true
          echo "XFCE desktop with macOS look ready."

      - name: Start VNC server (passworded or passwordless)
        run: |
          export DISPLAY=:0
          if [ -n "${{ github.event.inputs.vnc_password }}" ]; then
            x11vnc -storepasswd "${{ github.event.inputs.vnc_password }}" ~/.vncpass
            x11vnc -display :0 -rfbport 5900 -forever -shared -rfbauth ~/.vncpass -noxdamage -bg
          else
            x11vnc -display :0 -rfbport 5900 -forever -shared -nopw -noxdamage -bg
          fi

      - name: Install and join ZeroTier
        run: |
          curl -s https://install.zerotier.com/ | sudo bash
          sudo zerotier-cli join "${{ github.event.inputs.zt_network }}"
          sleep 10
          sudo zerotier-cli listnetworks

      - name: Auto-authorize member (optional)
        if: ${{ github.event.inputs.zt_api_token != '' }}
        run: |
          NET="${{ github.event.inputs.zt_network }}"
          TOK="${{ github.event.inputs.zt_api_token }}"
          NODE=$(sudo zerotier-cli info -j | jq -r .address)
          curl -fsSL -X POST -H "Authorization: token $TOK" \
            -H "Content-Type: application/json" \
            -d '{"config":{"authorized":true}}' \
            "https://api.zerotier.com/api/v1/network/${NET}/member/${NODE}" || true

      - name: Show connect info
        run: |
          IP=$(ip -4 -o addr show | awk '/zt/{print $4}' | cut -d/ -f1 | head -n1)
          echo "============== Connect =============="
          echo "VNC address: ${IP}:5900"
          if [ -n "${{ github.event.inputs.vnc_password }}" ]; then
            echo "Password   : ${{ github.event.inputs.vnc_password }}"
          else
            echo "Password   : none (passwordless)"
          fi
          echo "Theme      : WhiteSur macOS look"
          echo "====================================="

      - name: Keepalive
        run: |
          for i in $(seq 1 ${{ github.event.inputs.minutes || 180 }}); do
            echo "Kali XFCE running ($i min) â€” connect via ZeroTier VNC"
            sleep 60
          done
