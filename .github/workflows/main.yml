name: macOS VNC via ZeroTier + TigerVNC

on:
  workflow_dispatch:
    inputs:
      zerotier_network:
        description: "ZeroTier Network ID from https://my.zerotier.com"
        required: true
      vnc_password:
        description: "VNC password (max 8 chars; extras ignored)"
        required: false
        default: "12345678"
      runtime_minutes:
        description: "Keep-alive runtime (max 360)"
        required: false
        default: "120"

permissions:
  contents: read

jobs:
  vnc:
    runs-on: macos-13
    timeout-minutes: 370
    steps:
      - name: Print connection summary
        shell: bash
        run: |
          echo "This job will:"
          echo " - Install ZeroTier and join your network"
          echo " - Start TigerVNC on TCP 5901"
          echo "Use any VNC client to connect to: <ZeroTier IP>:5901"
          echo "Password is the first 8 characters you provide."

      - name: Install TigerVNC and set password
        shell: bash
        run: |
          set -euo pipefail
          brew update >/dev/null
          brew install tigervnc >/dev/null
          mkdir -p "$HOME/.vnc"
          VNC_PW="${{ inputs.vnc_password }}"
          VNC_PW="${VNC_PW:0:8}"
          printf '%s\n' "$VNC_PW" | vncpasswd -f > "$HOME/.vnc/passwd"
          chmod 600 "$HOME/.vnc/passwd"
          VNC_BIN="$(command -v vncserver)"
          nohup "$VNC_BIN" -geometry 1280x720 -SecurityTypes VncAuth :1 > "$HOME/vnc.log" 2>&1 &
          sleep 3
          echo "TigerVNC started on display :1 (port 5901)."

      - name: Install and join ZeroTier
        shell: bash
        run: |
          set -euo pipefail
          curl -fL https://install.zerotier.com/ -o zt.sh
          sudo bash zt.sh
          sudo zerotier-cli status || true
          sudo zerotier-cli join "${{ inputs.zerotier_network }}"
          echo "Joined ZeroTier network: ${{ inputs.zerotier_network }}"
          echo "Authorize this member in the ZeroTier web dashboard."

      - name: Wait for ZeroTier IP
        shell: bash
        run: |
          set -euo pipefail
          i=0
          ZT_IP=""
          while [ $i -lt 18 ]; do
            # Try JSON first
            if sudo zerotier-cli listnetworks -j >/tmp/zt.json 2>/dev/null; then
              ZT_IP=$(sed -E 's/[{},"\[\]]/ /g' /tmp/zt.json | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -n1 || true)
            fi
            # Fallback to plain output
            if [ -z "$ZT_IP" ]; then
              ZT_IP=$(sudo zerotier-cli listnetworks 2>/dev/null | grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -n1 || true)
            fi
            [ -n "$ZT_IP" ] && break
            i=$((i+1))
            sleep 5
          done

          if [ -n "$ZT_IP" ]; then
            echo "ZT_IP=$ZT_IP" >> "$GITHUB_ENV"
            echo "======================================"
            echo "Connect now with any VNC client:"
            echo " Address : $ZT_IP:5901"
            echo " Password: first 8 chars you entered"
            echo "======================================"
          else
            echo "No ZeroTier IP yet. Authorize this runner in the ZeroTier dashboard, then connect to <ZeroTier IP>:5901."
          fi

      - name: Keep alive
        shell: bash
        run: |
          rt="${{ inputs.runtime_minutes }}"
          case "$rt" in
            (''|*[!0-9]*) rt=120 ;;
          esac
          [ "$rt" -gt 360 ] && rt=360
          end=$(( $(date +%s) + 60*rt ))
          while [ "$(date +%s)" -lt "$end" ]; do
            echo "[ZeroTier+TigerVNC] Heartbeat $(date '+%H:%M:%S') | target: ${ZT_IP:-authorize in dashboard}:5901"
            sleep 60
          done
